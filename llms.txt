# CalcTree GraphQL API

> CalcTree is a computational platform for engineering calculations and data management.

API Endpoint: https://graph.calctree.com/graphql

## Authentication

All API requests require authentication using an API key in the `x-api-key` header:

```
x-api-key: YOUR_API_KEY
```

Example with curl:
```bash
curl -X POST https://graph.calctree.com/graphql \
  -H "Content-Type: application/json" \
  -H "x-api-key: YOUR_API_KEY" \
  -d '{"query":"{ currentUser { id email } }"}'
```

Example with Python:
```python
import requests

headers = {
    "Content-Type": "application/json",
    "x-api-key": "YOUR_API_KEY"
}

response = requests.post(
    "https://graph.calctree.com/graphql",
    headers=headers,
    json={"query": "{ currentUser { id email } }"}
)
```

To obtain an API key, visit your CalcTree account settings.

## Core Concepts

- **Workspace**: A container for pages, calculations, and data
- **Page**: A document that can contain calculations, files, and datasets
- **Calculation**: A collection of executable statements with formulas and variables
- **Statement**: A single formula or variable assignment within a calculation
- **Dataset**: Structured data (tables/columns) that can be used in calculations
- **PageFile**: Files attached to pages (Excel, images, etc.)

## Calculations

### Create a Calculation (Synchronous)

Create a new calculation with multiple statements and get immediate results:

```graphql
mutation CreateCalculation {
  createCalculationWithMultipleStatementsSync(
    workspaceId: "workspace_id"
    pageId: "page_id"
    statements: [
      { title: "length", formula: "10", unit: "m" }
      { title: "width", formula: "5", unit: "m" }
      { title: "area", formula: "length * width", unit: "m^2" }
    ]
  ) {
    id
    revisionId
    statements {
      id
      title
      formula
      value
      unit
    }
  }
}
```

### Run Calculation with Variable Inputs

Execute an existing calculation with different input values without modifying the stored calculation:

```graphql
query RunCalculation {
  simpleCalculate(
    workspaceId: "workspace_id"
    calculationId: "calc_id"
    scope: [
      { name: "length", value: 15 }
      { name: "width", value: 8 }
    ]
  ) {
    statements {
      title
      value
      unit
    }
  }
}
```

### Get Calculation

Retrieve a specific calculation with all its statements:

```graphql
query GetCalculation {
  calculation(
    workspaceId: "workspace_id"
    calculationId: "calc_id"
    revisionId: "revision_id"
  ) {
    id
    revisionId
    statements {
      id
      title
      formula
      value
      unit
      error
    }
  }
}
```

### Add Statement to Calculation

Add a new statement to an existing calculation:

```graphql
mutation AddStatement {
  addStatementToCalculation(
    workspaceId: "workspace_id"
    calculationId: "calc_id"
    revisionId: "current_revision_id"
    statement: {
      title: "new_variable"
      formula: "existing_var * 2"
      unit: "m"
    }
  ) {
    correlationId
  }
}
```

### Update Statement

Modify an existing statement in a calculation:

```graphql
mutation UpdateStatement {
  updateCalculation(
    workspaceId: "workspace_id"
    calculationId: "calc_id"
    revisionId: "current_revision_id"
    statementId: "statement_id"
    statement: {
      title: "updated_variable"
      formula: "new_formula"
      unit: "mm"
    }
  ) {
    correlationId
  }
}
```

### Delete Statement

Remove a statement from a calculation:

```graphql
mutation DeleteStatement {
  deleteStatement(
    workspaceId: "workspace_id"
    calculationId: "calc_id"
    revisionId: "current_revision_id"
    statementId: "statement_id"
  ) {
    correlationId
  }
}
```

### Duplicate Calculation

Copy a calculation to a new location:

```graphql
mutation DuplicateCalculation {
  duplicateCalculation(
    workspaceId: "workspace_id"
    calculationId: "calc_id"
    targetWorkspaceId: "target_workspace_id"
    targetPageId: "target_page_id"
  ) {
    id
    revisionId
  }
}
```

## Pages

### Get All Pages in Workspace

```graphql
query GetPages {
  pages(workspaceId: "workspace_id") {
    id
    title
    parentId
    createdAt
    updatedAt
  }
}
```

### Get Single Page

```graphql
query GetPage {
  page(workspaceId: "workspace_id", id: "page_id") {
    id
    title
    parentId
    isPublic
    createdAt
    updatedAt
  }
}
```

### Create Page

```graphql
mutation CreatePage {
  createPageSync(
    workspaceId: "workspace_id"
    page: {
      title: "New Page"
      parentId: "parent_page_id"
    }
  ) {
    id
    title
  }
}
```

### Update Page

```graphql
mutation UpdatePage {
  updatePage(
    workspaceId: "workspace_id"
    id: "page_id"
    page: {
      title: "Updated Title"
    }
  ) {
    id
    title
  }
}
```

### Delete Page

```graphql
mutation DeletePage {
  deletePage(
    workspaceId: "workspace_id"
    id: "page_id"
  ) {
    id
  }
}
```

### Duplicate Page

```graphql
mutation DuplicatePage {
  duplicatePage(
    workspaceId: "workspace_id"
    pageId: "page_id"
    targetParentId: "target_parent_id"
  ) {
    id
    title
  }
}
```

### Duplicate Page to Another Workspace

```graphql
mutation DuplicatePageToWorkspace {
  duplicatePageIntoWorkspace(
    sourceWorkspaceId: "source_workspace_id"
    targetWorkspaceId: "target_workspace_id"
    pageId: "page_id"
    targetParentId: "target_parent_id"
  ) {
    id
    title
  }
}
```

### Get Page Tree Structure

```graphql
query GetPageTree {
  pageTree(workspaceId: "workspace_id") {
    id
    title
    children {
      id
      title
      children {
        id
        title
      }
    }
  }
}
```

### Get Page Content

```graphql
query GetPageContent {
  pageContent(
    workspaceId: "workspace_id"
    pageId: "page_id"
  ) {
    markdown
    calculations {
      id
      revisionId
    }
  }
}
```

## File Management

### Upload File to Page

1. Create presigned upload URL:

```graphql
mutation GetUploadURL {
  createPresignedUploadPost(
    workspaceId: "workspace_id"
    fileName: "data.xlsx"
    contentType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
  ) {
    url
    fields
    key
  }
}
```

2. Upload file to S3 using the presigned URL (use HTTP POST with the fields from response)

3. Add file reference to workspace:

```graphql
mutation AddFileToWorkspace {
  addWorkspaceFile(
    workspaceId: "workspace_id"
    key: "file_key_from_step_1"
    fileName: "data.xlsx"
    contentType: "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
    size: 12345
  ) {
    id
    fileName
    url
  }
}
```

### Get Page Files

```graphql
query GetPageFiles {
  pageFiles(
    workspaceId: "workspace_id"
    pageId: "page_id"
  ) {
    id
    fileName
    contentType
    size
    url
    createdAt
  }
}
```

### Get File Details

```graphql
query GetFile {
  pageFile(id: "file_id") {
    id
    fileName
    contentType
    size
    url
    pageId
  }
}
```

### Update File Sharing Settings

```graphql
mutation UpdateFileSharing {
  updatePageFileSharing(
    fileId: "file_id"
    shared: true
  ) {
    id
    shared
  }
}
```

## Datasets

### Get Dataset

```graphql
query GetDataset {
  dataset(id: "dataset_id") {
    id
    name
    columns {
      id
      name
      type
    }
    rows
  }
}
```

### Add Column to Dataset

```graphql
mutation AddColumn {
  addDatasetColumn(
    datasetId: "dataset_id"
    column: {
      name: "new_column"
      type: "number"
    }
  ) {
    id
    columns {
      id
      name
      type
    }
  }
}
```

### Update Dataset Column

```graphql
mutation UpdateColumn {
  updateDatasetColumn(
    datasetId: "dataset_id"
    columnId: "column_id"
    column: {
      name: "updated_name"
      type: "text"
    }
  ) {
    id
    columns {
      id
      name
      type
    }
  }
}
```

## Workspace Management

### Get Current User

```graphql
query GetCurrentUser {
  currentUser {
    id
    email
    fullName
    workspaces {
      id
      name
      role
    }
  }
}
```

### Get Workspaces by User

```graphql
query GetUserWorkspaces {
  workspacesByUserId(userId: "user_id") {
    id
    name
    description
    createdAt
  }
}
```

### Get Workspace

```graphql
query GetWorkspace {
  workspace(id: "workspace_id") {
    id
    name
    description
    members {
      userId
      role
      email
    }
  }
}
```

## Page Parameters (Variables)

Page parameters are reusable variables that can be referenced across calculations on a page.

### Get Page Parameters

```graphql
query GetPageParameters {
  pageParameters(
    workspaceId: "workspace_id"
    pageId: "page_id"
  ) {
    id
    title
    value
    unit
    description
  }
}
```

### Create Page Parameter

```graphql
mutation CreateParameter {
  createPageParameterSync(
    workspaceId: "workspace_id"
    pageId: "page_id"
    parameter: {
      title: "default_length"
      value: 100
      unit: "mm"
      description: "Default length for calculations"
    }
  ) {
    id
    title
    value
    unit
  }
}
```

### Update Page Parameter

```graphql
mutation UpdateParameter {
  updatePageParameter(
    workspaceId: "workspace_id"
    id: "parameter_id"
    parameter: {
      value: 150
      unit: "mm"
    }
  ) {
    id
    value
    unit
  }
}
```

### Delete Page Parameter

```graphql
mutation DeleteParameter {
  deletePageParameter(
    workspaceId: "workspace_id"
    id: "parameter_id"
  ) {
    id
  }
}
```

## Common Patterns

### Create Page with Calculation

```graphql
mutation CreatePageWithCalc {
  page: createPageSync(
    workspaceId: "workspace_id"
    page: { title: "Beam Analysis" }
  ) {
    id
  }
}

# Then create calculation:
mutation CreateCalc {
  createCalculationWithMultipleStatementsSync(
    workspaceId: "workspace_id"
    pageId: "page_id_from_above"
    statements: [
      { title: "load", formula: "1000", unit: "N" }
      { title: "length", formula: "5", unit: "m" }
      { title: "moment", formula: "load * length", unit: "N*m" }
    ]
  ) {
    id
  }
}
```

### Upload and Reference Dataset

1. Upload file containing data (see File Management section)
2. Reference dataset in calculation formulas
3. Use dataset columns in statements

### Duplicate Page with All Resources

```graphql
mutation DuplicateWithResources {
  duplicatePageIntoWorkspace(
    sourceWorkspaceId: "source_ws"
    targetWorkspaceId: "target_ws"
    pageId: "page_id"
  ) {
    id
    title
  }

  duplicatePageResources(
    sourceWorkspaceId: "source_ws"
    targetWorkspaceId: "target_ws"
    pageId: "page_id"
  ) {
    files {
      id
      fileName
    }
  }
}
```

## Error Handling

Errors in calculations are returned in the statement's error field:

```graphql
{
  calculation {
    statements {
      title
      value
      error  # null if no error, string message if error occurred
    }
  }
}
```

GraphQL errors follow standard format:
```json
{
  "errors": [
    {
      "message": "Error description",
      "path": ["field", "path"],
      "extensions": {
        "code": "ERROR_CODE"
      }
    }
  ]
}
```

## Best Practices

1. **Use revisionId**: Always include the current revisionId when updating calculations to prevent conflicts
2. **Batch operations**: Use `createCalculationWithMultipleStatementsSync` instead of creating statements one-by-one
3. **Async for production**: Use async mutations (`createCalculation`, `addStatementToCalculation`) for complex calculations that might timeout
4. **Test with simpleCalculate**: Use `simpleCalculate` to test formula changes before updating stored calculations
5. **Handle errors**: Check both GraphQL errors and statement-level errors in responses
6. **Page hierarchy**: Organize pages in a tree structure using parentId for better organization
7. **Workspace isolation**: All operations are workspace-scoped for data security
8. **Units**: Always specify units for engineering calculations for clarity and automatic unit conversion

## Subscription Support

For real-time updates on calculation execution (when using async mutations), subscribe to the sync endpoint:

```graphql
subscription WatchCalculations {
  sync(workspaceId: "workspace_id") {
    edges {
      node {
        type
        calculationId
        revisionId
        data
      }
    }
  }
}
```

## Rate Limits

Contact CalcTree for information about rate limits and usage quotas for your API key.

## Support

- Documentation: https://docs.calctree.com
- API Issues: support@calctree.com
- GraphQL Playground: https://graph.calctree.com/graphql (interactive API explorer)

---

# CalcTree MDX Math Block Generation

## Overview

CalcTree supports embedding calculations directly in markdown documents using MDX EquationBlock components. This section provides instructions for generating properly formatted CalcTree MDX syntax.

## Critical Format Rules

- Output markdown/MDX formatted text only
- Use blank lines between all content blocks
- NO backticks, indentation, or code block formatting around EquationBlocks
- Write EquationBlock as raw MDX directly in the markdown

## EquationBlock Syntax

```
<EquationBlock name="BlockName" formula='statement1\nstatement2\nstatement3' />
```

### Key Requirements

1. **Blank lines** before and after each EquationBlock (mandatory)
2. Use `\n` to separate statements within formula attribute
3. Use single quotes (') for formula attribute if it contains double quotes
4. **NO comments on same line** - All explanations/comments must be in plain text BEFORE the EquationBlock, never inline with variables/functions

## Variable Rules

- Define variables before use in formulas
- No apostrophes in variable names (use underscores: `f_c` not `f'c`)
- String values need double quotes within the formula
- Use mathjs syntax for mathematical operations
- **UNITS**: Only put units on INPUT variables. Calculated values will have units computed automatically by the engine

## Function Definition Support

You can define and use custom functions within EquationBlock:

```
<EquationBlock name="Functions" formula='f(x) = x^3\nc = f(3)\ng(a,b) = a * b + 2\nresult = g(5, 10)' />
```

Functions are defined with standard mathematical notation and can be called with parameters.

## Document Structure Order

### 1. Inputs - All Input Variables WITH UNITS

```
<EquationBlock name="Inputs" formula='P = 50 kN\nL = 6 m\nE = 200000 MPa' />
```

### 2. Calculations - Intermediate Calculations

NO UNITS on calculated values - they are automatically computed from inputs:

```
<EquationBlock name="Calculations" formula='M_max = P * L / 4\ndelta = P * L^3 / (48 * E * I)' />
```

### 3. Checks - Results and Conditional Checks

```
<EquationBlock name="Checks" formula='Check = Actual <= Allowable ? "OK" : "NG"' />
```

## Comments and Descriptions

**CORRECT** - Comment before block:
```
This calculates the maximum moment for a simply supported beam:

<EquationBlock name="Moment" formula='M_max = w * L^2 / 8' />
```

**INCORRECT** - Never inline comments:
```
<EquationBlock name="Moment" formula='M_max = w * L^2 / 8  # maximum moment' />
```

All explanatory text must be in markdown above or below the EquationBlock, never inside the formula attribute.

## Conditional Logic

Use ternary operators for checks and conditional values:

```
result = condition ? "OK" : "NG"
utilization_ratio = demand / capacity
status = utilization_ratio <= 1.0 ? "PASS" : "FAIL"
```

## Mathematical Operations

CalcTree uses mathjs syntax. Common operations:

- Addition: `a + b`
- Subtraction: `a - b`
- Multiplication: `a * b`
- Division: `a / b`
- Exponentiation: `a^b` or `pow(a, b)`
- Square root: `sqrt(x)`
- Absolute value: `abs(x)`
- Min/max: `min(a, b, c)`, `max(a, b, c)`
- Trigonometry: `sin(x)`, `cos(x)`, `tan(x)`

## String Comparisons

Use `equalText()` function for string comparisons:

```
result = equalText(material, "Steel") ? steel_value : concrete_value
```

## Example with Functions and Multiple Conditions

```
Define load factors based on member type:

<EquationBlock name="LoadFactors" formula='phi(type) = equalText(type, "Beam") ? 0.8 : equalText(type, "Column") ? 0.6 : 0.7\nmember_type = "Beam"\nfactor = phi(member_type)' />
```

## Complete Example: Beam Deflection Check

```
Calculate beam deflection with safety check:

<EquationBlock name="Inputs" formula='P = 50 kN\nL = 6 m\nE = 200000 MPa\nI = 300e6 mm^4\nallowable_deflection = 25 mm' />

Define deflection calculation function:

<EquationBlock name="Functions" formula='deflection(P, L, E, I) = (P * 1000 * (L * 1000)^3) / (48 * E * I)\ndelta_max = deflection(P, L, E, I)' />

Check if deflection is within limits:

<EquationBlock name="Checks" formula='deflection_check = delta_max <= allowable_deflection ? "OK" : "NG"' />
```

## Complete Example: Concrete Column Design

```
# Concrete Column Design to AS3600

## Design Parameters

<EquationBlock name="Inputs" formula='N_star = 1500 kN\nf_c = 32 MPa\nD = 400 mm\nB = 400 mm\ncover = 40 mm' />

## Concrete Properties

Define concrete strength reduction factors:

<EquationBlock name="Properties" formula='alpha_1 = 0.85 - 0.0015 * f_c\nalpha_1_final = alpha_1 >= 0.67 ? alpha_1 : 0.67\nalpha_2 = 0.85 - 0.0025 * f_c\nalpha_2_final = alpha_2 >= 0.67 ? alpha_2 : 0.67' />

## Section Capacity

Calculate gross cross-sectional area and capacity:

<EquationBlock name="Capacity" formula='A_g = B * D\nphi = 0.6\nN_uo = 0.85 * f_c * A_g\nphi_N_uo = phi * N_uo' />

## Design Check

<EquationBlock name="Check" formula='utilization = N_star / phi_N_uo\nstatus = utilization <= 1.0 ? "PASS" : "FAIL"' />

The column has a utilization ratio shown above and the design check status is displayed.
```

## Best Practices for MDX Generation

1. **Always use blank lines** around EquationBlocks
2. **Group related calculations** in the same EquationBlock
3. **Use descriptive names** for EquationBlock components (e.g., "Inputs", "BeamCapacity", "SafetyChecks")
4. **Define inputs first**, then calculations, then checks
5. **Only specify units on inputs** - let CalcTree compute output units
6. **Use functions for reusable logic** rather than repeating formulas
7. **Add markdown descriptions** above blocks to explain what they calculate
8. **Use ternary operators** for conditional logic and checks
9. **Avoid inline comments** - all documentation should be in markdown, not in formulas

## Integration with Page Content Mutation

When creating page content via the API, embed EquationBlocks in the markdown:

```graphql
mutation UpdatePageContent {
  putInitialPageContent(
    workspaceId: "workspace_id"
    pageId: "page_id"
    content: {
      markdown: "# My Calculation\n\n<EquationBlock name='Inputs' formula='x = 5\\ny = 10\\nresult = x * y' />\n\nThe result shows the product."
    }
  )
}
```

Note: In GraphQL strings, backslashes must be escaped (`\\n` instead of `\n`).
